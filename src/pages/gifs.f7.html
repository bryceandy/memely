<template>
  <div class="page" data-name="gifs">
    <!-- Top Navbar -->
    <div class="navbar navbar-large">
      <div class="navbar-bg"></div>
      <div class="navbar-inner">
        <div class="right">
          <!-- Link to enable searchbar -->
          <a class="link icon-only searchbar-enable" data-searchbar=".gifs-searchbar">
            <i class="icon f7-icons if-not-md">search</i>
            <i class="icon material-icons md-only">search</i>
          </a>
        </div>
        <!-- Searchbar is a direct child of "navbar-inner" -->
        <form class="searchbar gifs-searchbar searchbar-expandable">
          <div class="searchbar-inner">
            <div class="searchbar-input-wrap">
              <input type="search" placeholder="Search"/>
              <i class="searchbar-icon"></i>
              <span class="input-clear-button"></span>
            </div>
            <span class="searchbar-disable-button">Cancel</span>
          </div>
        </form>
        <div class="title sliding">
          <img src="static/memely.svg" alt="logo" class="title-logo">
        </div>
        <div class="title-large">
          <div class="title-large-text">
            trending gifs
          </div>
        </div>
      </div>
    </div>

    <!-- Scrollable page content-->
    <div class="page-content gifs-page-content ptr-content" data-ptr-distance="55" data-ptr-mousewheel="false">
      <!-- Default pull to refresh preloader-->
      <div class="ptr-preloader gifs-ptr">
        <div class="preloader"></div>
        <div class="ptr-arrow"></div>
      </div>
      <div id="gifs" class="margin-top-half row searchbar-hide-on-search">
        <div class="left col-50"></div>
        <div class="right col-50"></div>
      </div>
      <div id="gif-search-results" class="margin-top-half row">
        <div class="left col-50"></div>
        <div class="right col-50"></div>
      </div>
    </div>
  </div>
</template>

<script>
    export default {
        on: {
            pageInit () {
                const myApp = this.$app, $$ = this.$$;

                // Create searchbar
                myApp.searchbar.create({
                    el: '.gifs-searchbar',
                    customSearch: true,
                    on: {
                        search (sb, query, previousQuery) {
                            myApp.preloader.show('orange');

                            // Request
                            myApp.request({
                                url: 'https://api.giphy.com/v1/gifs/search?q='+query+'&api_key='+myApp.data.giphyApiKey,
                                method: 'GET',
                                dataType: 'json',
                                success(data, status, xhr) {
                                    myApp.preloader.hide();
                                    // Clear and render results
                                    $$('#gif-search-results .left').empty();
                                    $$('#gif-search-results .right').empty();

                                    data.data.forEach(function (gif, index) {
                                        if (index % 2 === 0) {
                                            $$('#gif-search-results .left').append(`<img class="elevation-2 left-image link" src="` + gif.images.fixed_width_downsampled.url + `" alt="` + gif.id + `"/>`)
                                        }
                                        else {
                                            $$('#gif-search-results .right').append(`<img class="elevation-2 right-image link" src="` + gif.images.fixed_width_downsampled.url + `" alt="` + gif.id + `"/>`)
                                        }
                                    })
                                },
                                error(xhr, status) {
                                    myApp.preloader.hide();
                                    myApp.toast.create({
                                        text: 'Failed to load gifs '+status,
                                        closeButton: true,
                                        closeButtonText: 'OK',
                                        closeButtonColor: 'red',
                                        closeTimeout: 4000,
                                    }).open()
                                }
                            })
                        },
                        disable () {
                            $$('#gif-search-results .left').empty();
                            $$('#gif-search-results .right').empty()
                        }
                    }
                });

                // See trending gifs
                myApp.request({
                    url: 'https://api.giphy.com/v1/gifs/trending?limit=100&api_key='+myApp.data.giphyApiKey,
                    method: 'GET',
                    dataType: 'json',
                    success(data, status, xhr) {
                        data.data.forEach(function (gif, index) {
                            if (index % 2 === 0) {
                                $$('#gifs .left').append(`<img class="elevation-2 left-image link" src="` + gif.images.fixed_width_downsampled.url + `" alt="` + gif.id + `"/>`)
                            }
                            else {
                                $$('#gifs .right').append(`<img class="elevation-2 right-image link" src="` + gif.images.fixed_width_downsampled.url + `" alt="` + gif.id + `"/>`)
                            }
                        })
                    },
                    error(xhr, status) {
                        myApp.toast.create({
                            text: 'Failed to load gifs '+status,
                            closeButton: true,
                            closeButtonText: 'OK',
                            closeButtonColor: 'red',
                            closeTimeout: 4000,
                        }).open()
                    }
                })
            },
            ptrPullEnd () {
                // Pull to refresh event
                const router = this.$router;
                setTimeout(() => router.refreshPage(), 1000)
            }
        }
    }
</script>
