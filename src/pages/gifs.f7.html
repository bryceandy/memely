<template>
  <div class="page" data-name="gifs">
    <!-- Top Navbar -->
    <div class="navbar navbar-large">
      <div class="navbar-bg"></div>
      <div class="navbar-inner">
        <div class="right">
          <!-- Link to enable searchbar -->
          <a class="link icon-only searchbar-enable" data-searchbar=".gifs-searchbar">
            <i class="icon f7-icons if-not-md">search</i>
            <i class="icon material-icons md-only">search</i>
          </a>
        </div>
        <!-- Searchbar is a direct child of "navbar-inner" -->
        <form class="searchbar gifs-searchbar searchbar-expandable">
          <div class="searchbar-inner">
            <div class="searchbar-input-wrap">
              <input type="search" placeholder="Search"/>
              <i class="searchbar-icon"></i>
              <span class="input-clear-button"></span>
            </div>
            <span class="searchbar-disable-button">Cancel</span>
          </div>
        </form>
        <div class="title sliding">
          <img src="static/memely.svg" alt="logo" class="title-logo">
        </div>
        <div class="title-large">
          <div class="title-large-text">
            trending gifs
          </div>
        </div>
      </div>
    </div>

    <!-- Scrollable page content-->
    <div class="page-content gifs-page-content ptr-content" data-ptr-distance="55" data-ptr-mousewheel="false">
      <!-- Default pull to refresh preloader-->
      <div class="ptr-preloader gifs-ptr">
        <div class="preloader"></div>
        <div class="ptr-arrow"></div>
      </div>
      <div id="gifs" class="margin-top-half row searchbar-hide-on-search">
        <div class="left col-50"></div>
        <div class="right col-50"></div>
      </div>
      <div id="gif-search-results" class="margin-top-half row">
        <div class="left col-50"></div>
        <div class="right col-50"></div>
      </div>
    </div>
    <!-- Sheet Modal Container -->
    <div class="sheet-modal gif-options-sheet-modal">
      <!-- Sheet Modal Toolbar -->
      <div class="toolbar">
        <div class="toolbar-inner">
          <div class="left"></div>
          <div class="title text-align-center">
            Gif Options
          </div>
          <div class="right"></div>
        </div>
      </div>
      <div class="sheet-modal-inner">
        <!-- Sheet Modal content -->
        <div class="block" style="margin: 8px 0">
          <div class="list no-hairlines no-hairlines-between" style="margin:0">
            <ul>
              <li class="item-content link sheet-close" @click="copyGif('{{activeGif}}')">
                <div class="item-media">
                  <i class="icon f7-icons">link</i>
                </div>
                <div class="item-inner">
                  <div class="item-title">
                    Copy gif link
                  </div>
                </div>
              </li>
              <li class="item-content link sheet-close" @click="shareGif('{{activeGif}}')">
                <div class="item-media">
                  <i class="icon f7-icons">arrow_turn_up_right</i>
                </div>
                <div class="item-inner">
                  <div class="item-title">
                    Share gif on
                  </div>
                </div>
              </li>
            </ul>
          </div>
          <button class="button button-fill button-large button-round sheet-close">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
    export default {
        data () {
            return {
                activeGif: null
            }
        },
        methods: {
            fetchTrendingGifs: ( async (app) => {

                return await app.request.promise({
                    url: 'https://api.giphy.com/v1/gifs/trending?limit=100&api_key='+app.data.giphyApiKey,
                    method: 'GET',
                    dataType: 'json'
                }).then( (result) => {
                    return result.data.data
                }).catch( (reason) => {
                    return app.toast.create({
                        text: 'Failed to load gifs '+reason.status,
                        closeButton: true,
                        closeButtonText: 'OK',
                        closeButtonColor: 'red',
                        closeTimeout: 4000,
                    }).open()
                })
            }),
            gifOptions (id) {
                const myApp = this.$app;
                // Gif will be known in the component
                this.$setState({
                    activeGif: id,
                });

                myApp.sheet.create({
                    el: '.gif-options-sheet-modal',
                    swipeToClose: true,
                    backdrop: true
                }).open(true)
            },
            copyGif (id) {
                const myApp = this.$app;

            },
            shareGif (id) {
                const myApp = this.$app, component = this;

                myApp.actions.create({
                    buttons: [
                        [
                            {
                                text: 'Share',
                                label: true
                            },
                            {
                                text: 'Mail',
                                onClick: function () {
                                    myApp.dialog.alert('share mail')
                                }
                            },
                            {
                                text: 'Messages',
                                onClick: function () {
                                    myApp.dialog.alert('share messages')
                                }
                            },
                            {
                                text: 'Save gif',
                                onClick: function () {
                                    myApp.dialog.alert('share device')
                                }
                            }
                        ],
                        [
                            {
                                text: 'Social share',
                                label: true
                            },
                            {
                                text: 'Facebook',
                                onClick: function () {
                                    myApp.dialog.alert('share facebook')
                                }
                            },
                            {
                                text: 'Twitter',
                                onClick: function () {
                                    myApp.dialog.alert('share twitter')
                                }
                            }
                        ],
                        [
                            {
                                text: 'Cancel',
                                color: 'red'
                            }
                        ]
                    ],
                }).open(true);
            }
        },
        on: {
            sheetClosed () {
                this.$setState({
                    activeGif: null
                })
            },
            pageInit () {
                const myApp = this.$app, $$ = this.$$, component = this;

                // Create searchbar
                myApp.searchbar.create({
                    el: '.gifs-searchbar',
                    customSearch: true,
                    on: {
                        search (sb, query, previousQuery) {
                            myApp.preloader.show('orange');

                            // Request
                            myApp.request({
                                url: 'https://api.giphy.com/v1/gifs/search?q='+query+'&api_key='+myApp.data.giphyApiKey,
                                method: 'GET',
                                dataType: 'json',
                                success(data, status, xhr) {
                                    myApp.preloader.hide();
                                    // Clear and render results
                                    $$('#gif-search-results .left').empty();
                                    $$('#gif-search-results .right').empty();

                                    data.data.forEach(function (gif, index) {
                                        if (index % 2 === 0) {
                                            $$('#gif-search-results .left').append(`<img class="elevation-2 left-image link" src="` + gif.images.fixed_width_downsampled.url + `" alt="` + gif.id + `"/>`)
                                        }
                                        else {
                                            $$('#gif-search-results .right').append(`<img class="elevation-2 right-image link" src="` + gif.images.fixed_width_downsampled.url + `" alt="` + gif.id + `"/>`)
                                        }
                                    })
                                },
                                error(xhr, status) {
                                    myApp.preloader.hide();
                                    myApp.toast.create({
                                        text: 'Failed to load gifs '+status,
                                        closeButton: true,
                                        closeButtonText: 'OK',
                                        closeButtonColor: 'red',
                                        closeTimeout: 4000,
                                    }).open()
                                }
                            })
                        },
                        disable () {
                            $$('#gif-search-results .left').empty();
                            $$('#gif-search-results .right').empty()
                        }
                    }
                });

                // Display trending gifs
                const output = new Promise( resolve => resolve(
                    // Call fetchTrendingGifs method as a promise
                    component.fetchTrendingGifs(myApp)
                ));

                promResult();
                async function promResult() {
                    // Assign the data result to a variable
                    let gifs = await output;

                    gifs.forEach(function (gif, index) {
                        if (index % 2 === 0) {
                            $$('#gifs .left').append(`<img class="elevation-2 loaded-image left-image link" src="` + gif.images.fixed_width_downsampled.url + `" alt="` + gif.id + `"/>`)
                        } else {
                            $$('#gifs .right').append(`<img class="elevation-2 loaded-image right-image link" src="` + gif.images.fixed_width_downsampled.url + `" alt="` + gif.id + `"/>`)
                        }
                    });
                }

                // Gif options onclick
                $$('#gifs').click('.link', function () {
                    return component.gifOptions($$(this).prop("alt"))
                })
            },
            ptrPullEnd () {
                // Pull to refresh events for this page component
                const component = this, $$ = component.$$;
                const output = new Promise( resolve => resolve(
                    // Call fetchTrendingGifs method as a promise
                    component.fetchTrendingGifs(component.$app)
                ));

                promiseResult();
                async function promiseResult() {
                    // Assign the data result to a variable
                    let gifs = await output;

                    // Stop the ptr from loading
                    setTimeout(() => {
                        component.$app.ptr.done('.gifs-page-content')
                    }, 1000);

                    // Check for a new gif that is not loaded and prepend it
                    let loadedIds = [];
                    $$('#gifs .loaded-image').forEach( (element) => {
                        loadedIds.push($$(element).prop("alt"))
                    });

                    gifs.forEach( (gif, index) => {
                        if (! loadedIds.includes(gif.id)) {
                            if (index % 2 === 0) {
                                $$('#gifs .left').prepend(`<img class="elevation-2 loaded-image left-image link" src="` + gif.images.fixed_width_downsampled.url + `" alt="` + gif.id + `"/>`)
                            }
                            else {
                                $$('#gifs .right').prepend(`<img class="elevation-2 loaded-image right-image link" src="` + gif.images.fixed_width_downsampled.url + `" alt="` + gif.id + `"/>`)
                            }
                        }
                    })
                }
            }
        }
    }
</script>
