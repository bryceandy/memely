<template>
  <div class="page" data-name="download-image">
    <!-- Top Navbar -->
    <div class="navbar navbar-large">
      <div class="navbar-bg"></div>
      <div class="navbar-inner">
        <div class="left">
          <a href="#" class="link back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title sliding">
          edit
        </div>
        <div class="right">
          {{> "menu-link"}}
        </div>
        <div class="title-large">
          <div class="title-large-text">
            edit
          </div>
        </div>
      </div>
    </div>

    <!-- Scrollable page content-->
    <div class="page-content download-image-page-content">
      <div class="row margin-top">
        {{#if downloaded}}
          <button class="button button-raised button-round button-large margin-left col-45" @click="discardImage('{{myFile}}')">
            Discard
          </button>
          <button class="button button-fill button-round button-large margin-right col-45" @click="editImage('{{myFile}}')">
            Edit
          </button>
          <!--<button class="button button-raised button-round button-large margin-right col-45" @click="shareMeme('{{myFile}}')">
            Share
          </button>-->
        {{/if}}
      </div>

      <div id="response" class="block">
      </div>
      {{#if editing}}

      {{/if}}
    </div>
  </div>
</template>
<script>
    export default {
        data: function () {
            return {
                downloaded: false,
                myFile: null,
                editing: false
            }
        },
        methods: {
            discardImage (fileName) {
                // Fetch the file
                let fileDirectory = cordova.file.externalApplicationStorageDirectory;
                const myApp = this.$app;

                if (myApp.device.ios) fileDirectory = cordova.file.tempDirectory;

                window.resolveLocalFileSystemURL(fileDirectory, function (dir) {
                    dir.getFile(fileName, { create: false }, function (fileEntry) {
                        // Delete
                        fileEntry.remove( function () {
                            myApp.views.current.router.back();
                            myApp.toast.create({
                                icon: '<i class="f7-icons">checkmark_alt</i>',
                                text: 'Discarded!',
                                position: 'center',
                                closeTimeout: 4000,
                            }).open();
                        })
                    }, function () {
                        myApp.toast.create({
                            text: 'The file does not exist',
                            closeButton: true,
                            closeButtonText: 'OK',
                            closeButtonColor: 'red',
                            closeTimeout: 4000,
                        }).open()
                    })
                })
            },
            editImage (fileName) {
                // Change state
                this.$setState({
                    downloaded: false,
                    myFile: fileName,
                    editing: true
                });
            },
            shareMeme (fileName) {
                // Fetch the file
                let fileDirectory = cordova.file.externalApplicationStorageDirectory;
                const myApp = this.$app;

                if (myApp.device.ios) fileDirectory = cordova.file.tempDirectory;

                window.resolveLocalFileSystemURL(fileDirectory, function (dir) {
                    dir.getFile(fileName, { create: false }, function (fileEntry) {

                        const filePath = fileEntry.toURL();
                        window.plugins.socialsharing.saveToPhotoAlbum([filePath], function () {
                            myApp.toast.create({
                                icon: '<i class="f7-icons">checkmark_alt</i>',
                                text: 'Saved!',
                                position: 'center',
                                closeTimeout: 4000,
                            }).open();
                            // Delete from tmp
                            fileEntry.remove();
                            myApp.views.current.router.back();
                        })
                    }, function () {
                        myApp.toast.create({
                            text: 'The file does not exist',
                            closeButton: true,
                            closeButtonText: 'OK',
                            closeButtonColor: 'red',
                            closeTimeout: 4000,
                        }).open()
                    })
                })
            },
            downloadImage (font, font_size, meme, top, bottom) {
                // Declarations
                const myApp = this.$app, $$ = this.$$, component = this,
                top_text = top.replace(' ', '%20'), bottom_text = bottom.replace(' ', '%20');

                // Save the requested image temporarily to display in the device it
                myApp.preloader.show('orange');

                // Using xmlhttp we can obtain a blob
                let oReq = new XMLHttpRequest();

                oReq.open("GET", myApp.data.requestingDomain+"meme?font="+font+"&font_size="+font_size+"&meme="+meme+"&top="+top_text+"&bottom="+bottom_text, true);
                oReq.responseType = "blob";
                oReq.setRequestHeader("x-rapidapi-host", myApp.data.XRapidAPIHost);
                oReq.setRequestHeader("x-rapidapi-key", myApp.data.XRapidAPIKey);
                oReq.onload = function () {

                    if ( oReq.response ) {
                        return saveAndRead(oReq.response)
                    }
                    myApp.preloader.hide();
                    return myApp.toast.create({
                        text: 'No response fetching the image!',
                        closeButton: true,
                        closeButtonText: 'OK',
                        closeButtonColor: 'red',
                    }).open()
                };
                oReq.onerror = function (err) {
                    myApp.preloader.hide();
                    return myApp.toast.create({
                        text: 'An error occured '+err.message,
                        closeButton: true,
                        closeButtonText: 'OK',
                        closeButtonColor: 'red',
                    }).open()
                };
                oReq.send(null);

                function saveAndRead(blob) {

                    const fileName = new Date().getTime()+'.jpeg';
                    let fileDirectory = cordova.file.externalApplicationStorageDirectory;

                    if (myApp.device.ios) fileDirectory = cordova.file.tempDirectory;

                    window.resolveLocalFileSystemURL( fileDirectory, function (dir) {
                        // Create file in the accessed directory

                        dir.getFile(fileName, { create: true }, function (fileEntry) {

                            fileEntry.createWriter(
                                // On success
                                function (fileWriter) {

                                    fileWriter.onwriteend = function() {
                                        myApp.preloader.hide();
                                        // Change state
                                        component.$setState({
                                            downloaded: true,
                                            myFile: fileName
                                        });
                                        //read file after writing
                                        const filePath = fileEntry.toURL();
                                        return $$('#response').append(`<img src="`+filePath+`" alt="downloaded" class="margin-top"/>`);
                                    };

                                    fileWriter.onerror = function(er) {
                                        myApp.toast.create({
                                            text: 'Unable to write file! '+er,
                                            closeButton: true,
                                            closeButtonText: 'OK',
                                            closeButtonColor: 'red',
                                        }).open()
                                    };

                                    fileWriter.write(blob);
                                },
                                // On error
                                function (err) {
                                    myApp.toast.create({
                                        text: 'Unable to create writer! '+err,
                                        closeButton: true,
                                        closeButtonText: 'OK',
                                        closeButtonColor: 'red',
                                    }).open()
                                }
                            );
                        })
                    })
                }
            }
        },
        on: {
            pageInit () {
                const meme = this.$route.params.name;

                this.downloadImage('Impact', 50, meme, 'top text', 'bottom text');
            }
        }
    }
</script>
